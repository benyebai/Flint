# Flint - System Design & Implementation Plan

> **PR Semantic Analysis Tool** - Help code reviewers understand the meaning and importance of code changes.

## Table of Contents

1. [Overview](#1-overview)
2. [System Architecture](#2-system-architecture)
3. [Component Design](#3-component-design)
4. [Data Flow](#4-data-flow)
5. [Database Schema](#5-database-schema)
6. [API Specification](#6-api-specification)
7. [Key Algorithms](#7-key-algorithms)
8. [Chrome Extension UI](#8-chrome-extension-ui)
9. [Deployment Architecture](#9-deployment-architecture)
10. [Implementation Plan](#10-implementation-plan)
11. [Tech Stack](#11-tech-stack)

---

## 1. Overview

### What is Flint?

Flint is a Chrome extension + backend service that analyzes GitHub Pull Requests and provides:

- **Semantic explanations** for each code change (what it does, why it matters)
- **Importance scoring** (ðŸ”´ High / ðŸŸ¡ Medium / ðŸŸ¢ Low) with reasoning
- **Review hints** (what reviewers should pay attention to)

### Key Features

| Feature | Description |
|---------|-------------|
| **Deep Context Gathering** | Clone repo in Vercel Sandbox, run ripgrep to find callers, tests, types |
| **Importance Scoring** | Heuristic-based scoring considering centrality, security, API surface |
| **LLM Semantic Analysis** | Claude-powered explanations of what each change means |
| **GitHub Integration** | Inline overlays injected directly into GitHub's PR diff view |

### Target Users

- **Code Reviewers** - Understand PRs faster, focus on what matters
- **Team Leads** - Quick overview of PR risk and scope
- **New Team Members** - Learn codebase through contextual explanations

---

## 2. System Architecture

### High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    FLINT SYSTEM                                          â”‚
â”‚                                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  Chrome Ext     â”‚â”€â”€â”€â”€â–¶â”‚  Next.js API    â”‚â”€â”€â”€â”€â–¶â”‚  Vercel Sandbox â”‚                   â”‚
â”‚  â”‚  (Frontend)     â”‚â—€â”€â”€â”€â”€â”‚  (Backend)      â”‚â—€â”€â”€â”€â”€â”‚  (Compute)      â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚          â”‚                       â”‚                       â”‚                              â”‚
â”‚          â”‚                       â–¼                       â”‚                              â”‚
â”‚          â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                              â”‚
â”‚          â”‚               â”‚  PostgreSQL     â”‚             â”‚                              â”‚
â”‚          â”‚               â”‚  (Cache/State)  â”‚             â”‚                              â”‚
â”‚          â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚                              â”‚
â”‚          â”‚                       â”‚                       â”‚                              â”‚
â”‚          â”‚                       â–¼                       â”‚                              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Claude API     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                          â”‚  (LLM)          â”‚                                            â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why Vercel Sandbox?

We need deep context to understand code changes:

| Approach | Capability | Limitation |
|----------|------------|------------|
| **GitHub API only** | Fetch files on demand | Rate limits, slow for many files, no regex search |
| **Vercel Sandbox** | Clone repo, run ripgrep, full filesystem | Ephemeral, costs per use |

Vercel Sandbox gives us:
- Full repo clone (shallow, fast)
- Run `ripgrep` for instant code search
- Parse AST, resolve imports
- No rate limits within the sandbox

---

## 3. Component Design

### 3.1 Chrome Extension (Client)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CHROME EXTENSION                                   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        Content Script                                  â”‚ â”‚
â”‚  â”‚  Injected into: github.com/**/pull/**                                  â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚   PR         â”‚  â”‚   Diff       â”‚  â”‚   UI         â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚   Detector   â”‚  â”‚   Parser     â”‚  â”‚   Injector   â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ URL parse â”‚  â”‚  â€¢ Find hunksâ”‚  â”‚  â€¢ Overlay   â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ PR info   â”‚  â”‚  â€¢ Extract   â”‚  â”‚  â€¢ Badges    â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Branch    â”‚  â”‚    context   â”‚  â”‚  â€¢ Panels    â”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     Background Service Worker                          â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚   Auth       â”‚  â”‚   API        â”‚  â”‚   Cache      â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚   Manager    â”‚  â”‚   Client     â”‚  â”‚   Manager    â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ OAuth     â”‚  â”‚  â€¢ REST      â”‚  â”‚  â€¢ IndexedDB â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Tokens    â”‚  â”‚  â€¢ Retry     â”‚  â”‚  â€¢ TTL       â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Refresh   â”‚  â”‚  â€¢ Queue     â”‚  â”‚  â€¢ Invalidateâ”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                           Popup UI                                     â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  â€¢ Login / Logout                                                      â”‚ â”‚
â”‚  â”‚  â€¢ Settings (theme, auto-analyze)                                      â”‚ â”‚
â”‚  â”‚  â€¢ Usage stats                                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**File Structure:**
```
extension/
â”œâ”€â”€ manifest.json              # Manifest V3
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ background.ts          # Service worker (auth, API calls)
â”‚   â”œâ”€â”€ content.tsx            # Content script (GitHub injection)
â”‚   â”œâ”€â”€ popup.tsx              # Extension popup (settings, login)
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ SemanticPanel.tsx  # Main overlay panel
â”‚   â”‚   â”œâ”€â”€ ImportanceBadge.tsx # ðŸ”´ðŸŸ¡ðŸŸ¢ badge with score
â”‚   â”‚   â””â”€â”€ LoadingState.tsx   # Loading skeleton
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ github.ts          # GitHub page detection
â”‚   â”‚   â”œâ”€â”€ api.ts             # Backend API client
â”‚   â”‚   â””â”€â”€ storage.ts         # Chrome storage helpers
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ overlay.css        # Styles for injected UI
```

### 3.2 Backend API (Next.js)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              NEXT.JS BACKEND                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                           API Routes                                   â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  POST /api/auth/github          OAuth callback, token exchange         â”‚ â”‚
â”‚  â”‚  GET  /api/auth/session         Get current user session               â”‚ â”‚
â”‚  â”‚  POST /api/auth/logout          Revoke tokens                          â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  POST /api/analyze              Analyze a PR (main endpoint)           â”‚ â”‚
â”‚  â”‚  GET  /api/analyze/:id          Get cached analysis                    â”‚ â”‚
â”‚  â”‚  GET  /api/analyze/status/:id   Poll analysis status                   â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  GET  /api/repos/:owner/:repo   Get repo metadata                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        Analysis Pipeline                               â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  1. SandboxManager                                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Create sandbox with repo clone                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Manage snapshots for fast restarts                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Handle timeouts and cleanup                               â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                              â”‚                                        â”‚ â”‚
â”‚  â”‚                              â–¼                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  2. DiffParser                                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Parse git diff output                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Extract hunks with line numbers                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Identify changed symbols (functions, classes)             â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                              â”‚                                        â”‚ â”‚
â”‚  â”‚                              â–¼                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  3. ContextGatherer                                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Run ripgrep to find callers/usages                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Parse AST for imports/exports                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Find related tests                                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Extract type definitions                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Load repo guidelines (AGENTS.md, etc.)                    â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                              â”‚                                        â”‚ â”‚
â”‚  â”‚                              â–¼                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  4. ImportanceScorer                                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Calculate centrality score                                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Detect security-sensitive changes                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Identify API/breaking changes                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Check test coverage                                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Generate importance tags                                  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                              â”‚                                        â”‚ â”‚
â”‚  â”‚                              â–¼                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  5. SemanticAnalyzer                                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Build LLM prompt with context                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Call Claude API                                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Parse structured response                                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Generate review hints                                     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        Data Layer                                      â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚  Postgres    â”‚  â”‚  Redis/KV    â”‚  â”‚  Blob Store  â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Users     â”‚  â”‚  â€¢ Sessions  â”‚  â”‚  â€¢ Snapshots â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Analyses  â”‚  â”‚  â€¢ Rate lim  â”‚  â”‚  â€¢ Logs      â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Repos     â”‚  â”‚  â€¢ Cache     â”‚  â”‚              â”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**File Structure:**
```
apps/web/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ github/route.ts    # OAuth callback
â”‚   â”‚   â”‚   â””â”€â”€ session/route.ts   # Get session
â”‚   â”‚   â”œâ”€â”€ analyze/
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts           # POST - start analysis
â”‚   â”‚   â”‚   â””â”€â”€ [id]/route.ts      # GET - get results
â”‚   â”‚   â””â”€â”€ repos/
â”‚   â”‚       â””â”€â”€ [owner]/[repo]/route.ts
â”‚   â””â”€â”€ page.tsx                   # Landing page
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ sandbox/
â”‚   â”‚   â”œâ”€â”€ manager.ts             # Create/manage sandboxes
â”‚   â”‚   â”œâ”€â”€ context.ts             # Context gathering logic
â”‚   â”‚   â””â”€â”€ commands.ts            # Sandbox command helpers
â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â”œâ”€â”€ diff.ts                # Diff parsing
â”‚   â”‚   â”œâ”€â”€ importance.ts          # Importance scoring
â”‚   â”‚   â””â”€â”€ semantic.ts            # LLM analysis
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ schema.ts              # Drizzle schema
â”‚   â”‚   â””â”€â”€ queries.ts             # Database queries
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ github.ts              # GitHub OAuth helpers
```

### 3.3 Vercel Sandbox (Compute)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            VERCEL SANDBOX                                    â”‚
â”‚                         (Ephemeral MicroVM)                                  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         Lifecycle                                      â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚   â”‚  Create  â”‚â”€â”€â”€â–¶â”‚  Clone   â”‚â”€â”€â”€â–¶â”‚  Analyze â”‚â”€â”€â”€â–¶â”‚  Stop    â”‚       â”‚ â”‚
â”‚  â”‚   â”‚          â”‚    â”‚  Repo    â”‚    â”‚          â”‚    â”‚          â”‚       â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚       â”‚                                                â”‚              â”‚ â”‚
â”‚  â”‚       â”‚                                                â–¼              â”‚ â”‚
â”‚  â”‚       â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Snapshot â”‚        â”‚ â”‚
â”‚  â”‚                 (optional, for reuse)            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Sandbox Filesystem                                  â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  /vercel/sandbox/                                                      â”‚ â”‚
â”‚  â”‚  â””â”€â”€ {repo}/                        â† cloned repository                â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ .git/                                                         â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ src/                                                          â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ package.json                                                  â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ tsconfig.json                                                 â”‚ â”‚
â”‚  â”‚      â”œâ”€â”€ AGENTS.md                                                     â”‚ â”‚
â”‚  â”‚      â””â”€â”€ ...                                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Available Commands                                  â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  â€¢ git diff origin/main...HEAD      Get PR changes                     â”‚ â”‚
â”‚  â”‚  â€¢ rg "pattern" --json              Search code (ripgrep)              â”‚ â”‚
â”‚  â”‚  â€¢ cat {file}                       Read file contents                 â”‚ â”‚
â”‚  â”‚  â€¢ find . -name "*.test.*"          Find test files                    â”‚ â”‚
â”‚  â”‚  â€¢ dnf install -y {package}         Install system packages            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 Analysis Pipeline Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ANALYSIS PIPELINE                                     â”‚
â”‚                                                                              â”‚
â”‚  Request â†’ SandboxManager â†’ DiffParser â†’ ContextGatherer â†’ ImportanceScorer â”‚
â”‚                                                      â†“                       â”‚
â”‚                                              SemanticAnalyzer â†’ Response     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Stage | Input | Output | Where |
|-------|-------|--------|-------|
| **SandboxManager** | PR info, token | Sandbox instance | Vercel Sandbox |
| **DiffParser** | `git diff` output | Structured hunks | Sandbox |
| **ContextGatherer** | Hunks | Context per hunk | Sandbox |
| **ImportanceScorer** | Hunks + context | Scores + tags | Backend |
| **SemanticAnalyzer** | Hunks + context + scores | Explanations | Claude API |

---

## 4. Data Flow

### 4.1 Full Analysis Flow (Sequence Diagram)

```
     Chrome Extension              Next.js Backend              Vercel Sandbox
           â”‚                             â”‚                            â”‚
           â”‚  1. User opens PR page      â”‚                            â”‚
           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶    â”‚                            â”‚
           â”‚                             â”‚                            â”‚
           â”‚  2. Click "Analyze"         â”‚                            â”‚
           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚                            â”‚
           â”‚  POST /api/analyze          â”‚                            â”‚
           â”‚  {owner, repo, pr, token}   â”‚                            â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  3. Create sandbox         â”‚
           â”‚                             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                             â”‚  Sandbox.create({          â”‚
           â”‚                             â”‚    source: git clone       â”‚
           â”‚                             â”‚  })                        â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  4. Clone complete         â”‚
           â”‚                             â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  5. Get diff               â”‚
           â”‚                             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                             â”‚  git diff main...HEAD      â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  6. Diff output            â”‚
           â”‚                             â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  7. Gather context         â”‚
           â”‚                             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                             â”‚  (parallel for each file)  â”‚
           â”‚                             â”‚  â€¢ rg find callers         â”‚
           â”‚                             â”‚  â€¢ read file               â”‚
           â”‚                             â”‚  â€¢ find tests              â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  8. Context results        â”‚
           â”‚                             â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  9. Stop sandbox           â”‚
           â”‚                             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                             â”‚  sandbox.stop()            â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  10. Score importance      â”‚
           â”‚                             â”‚  (local computation)       â”‚
           â”‚                             â”‚                            â”‚
           â”‚                             â”‚  11. LLM analysis          â”‚
           â”‚                             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Claude API â”‚
           â”‚                             â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
           â”‚                             â”‚                            â”‚
           â”‚  12. Analysis complete      â”‚                            â”‚
           â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
           â”‚  { hunks: [...] }           â”‚                            â”‚
           â”‚                             â”‚                            â”‚
           â”‚  13. Inject overlays        â”‚                            â”‚
           â”‚  into GitHub DOM            â”‚                            â”‚
           â”‚                             â”‚                            â”‚
```

### 4.2 Core Data Flow

```
User clicks "Analyze" on GitHub PR
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Extension: Extract PR info          â”‚
â”‚  { owner, repo, prNumber, branch }   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend: POST /api/analyze          â”‚
â”‚  Return analysisId immediately       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sandbox: Clone repo (shallow)       â”‚
â”‚                                      â”‚
â”‚  Sandbox.create({                    â”‚
â”‚    source: { type: 'git', ... },     â”‚
â”‚    depth: 1,                         â”‚
â”‚    revision: prBranch                â”‚
â”‚  })                                  â”‚
â”‚                                      â”‚
â”‚  Time: ~10-30 seconds                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sandbox: Get diff                   â”‚
â”‚  git diff origin/main...HEAD         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sandbox: Gather context (parallel)  â”‚
â”‚                                      â”‚
â”‚  For each changed file:              â”‚
â”‚  â”œâ”€ rg "import.*{file}" â†’ callers    â”‚
â”‚  â”œâ”€ Read containing function         â”‚
â”‚  â”œâ”€ Find related tests               â”‚
â”‚  â””â”€ Load AGENTS.md guidelines        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sandbox: Stop (cleanup)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend: Score importance           â”‚
â”‚  (heuristic calculation)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend: LLM semantic analysis      â”‚
â”‚  (Claude API, batched)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend: Cache results in DB        â”‚
â”‚  Return to extension                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Extension: Inject overlays          â”‚
â”‚  on each diff hunk in GitHub UI      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Context Gathering Detail

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Changed File   â”‚
                              â”‚  src/auth.ts    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                           â”‚                           â”‚
           â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Find Callers       â”‚   â”‚  Find Tests         â”‚   â”‚  Read Guidelines    â”‚
â”‚                     â”‚   â”‚                     â”‚   â”‚                     â”‚
â”‚  rg "import.*auth"  â”‚   â”‚  find . -name       â”‚   â”‚  cat AGENTS.md      â”‚
â”‚  --json             â”‚   â”‚  "auth.test.*"      â”‚   â”‚  cat CONTRIBUTING   â”‚
â”‚                     â”‚   â”‚                     â”‚   â”‚                     â”‚
â”‚  Result:            â”‚   â”‚  Result:            â”‚   â”‚  Result:            â”‚
â”‚  â€¢ src/login.ts     â”‚   â”‚  â€¢ auth.test.ts     â”‚   â”‚  "Review security   â”‚
â”‚  â€¢ src/session.ts   â”‚   â”‚  â€¢ auth.spec.ts     â”‚   â”‚   changes carefully"â”‚
â”‚  â€¢ src/api/user.ts  â”‚   â”‚                     â”‚   â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                           â”‚                           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Combined Context       â”‚
                        â”‚                         â”‚
                        â”‚  {                      â”‚
                        â”‚    callers: [3 files],  â”‚
                        â”‚    tests: [2 files],    â”‚
                        â”‚    guidelines: "...",   â”‚
                        â”‚    imports: [...],      â”‚
                        â”‚    containingFn: "..."  â”‚
                        â”‚  }                      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Database Schema

```sql
-- Users (GitHub OAuth)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  github_id TEXT UNIQUE NOT NULL,
  github_username TEXT NOT NULL,
  github_token TEXT NOT NULL,  -- encrypted
  email TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Repositories (for snapshot caching)
CREATE TABLE repositories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  owner TEXT NOT NULL,
  repo TEXT NOT NULL,
  
  -- Vercel Sandbox snapshot for fast restarts
  snapshot_id TEXT,
  snapshot_created_at TIMESTAMP,
  snapshot_expires_at TIMESTAMP,  -- 7 days
  
  -- Cached metadata
  default_branch TEXT DEFAULT 'main',
  guidelines TEXT,  -- AGENTS.md content
  
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(owner, repo)
);

-- PR Analyses (cached results)
CREATE TABLE analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- PR identification
  owner TEXT NOT NULL,
  repo TEXT NOT NULL,
  pr_number INT NOT NULL,
  commit_sha TEXT NOT NULL,
  
  -- Status
  status TEXT NOT NULL DEFAULT 'pending',
  -- 'pending' | 'running' | 'completed' | 'failed'
  error TEXT,
  
  -- Results
  result JSONB,
  /*
    {
      hunks: [{
        file, startLine, endLine,
        semantic: { summary, intent, behaviorChange, implications, reviewHints },
        importance: { score, level, factors, tags },
        context: { callers, tests, containingFunction }
      }],
      metadata: { totalFiles, totalHunks, analysisTime }
    }
  */
  
  user_id UUID REFERENCES users(id),
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(owner, repo, pr_number, commit_sha)
);

-- Indexes
CREATE INDEX idx_analyses_pr ON analyses(owner, repo, pr_number);
CREATE INDEX idx_analyses_status ON analyses(status) WHERE status = 'running';
```

---

## 6. API Specification

### Authentication

```yaml
POST /api/auth/github:
  description: GitHub OAuth callback
  request:
    body:
      code: string  # OAuth code from GitHub
  response:
    200:
      user:
        id: string
        githubUsername: string
      token: string  # JWT session token

GET /api/auth/session:
  description: Get current session
  headers:
    Authorization: Bearer {token}
  response:
    200:
      user:
        id: string
        githubUsername: string
    401:
      error: "Unauthorized"

POST /api/auth/logout:
  description: Logout
  headers:
    Authorization: Bearer {token}
  response:
    200:
      success: true
```

### Analysis

```yaml
POST /api/analyze:
  description: Analyze a PR
  headers:
    Authorization: Bearer {token}
  request:
    body:
      owner: string        # GitHub owner
      repo: string         # Repository name
      prNumber: number     # PR number
      branch: string       # PR branch name
  response:
    202:
      analysisId: string   # Poll this for status
      status: "pending"
    
GET /api/analyze/{analysisId}:
  description: Get analysis result
  headers:
    Authorization: Bearer {token}
  response:
    200:
      id: string
      status: "completed"
      result:
        hunks:
          - file: string
            startLine: number
            endLine: number
            semantic:
              summary: string
              intent: string
              behaviorChange: string
              implications: string[]
              reviewHints: string[]
            importance:
              score: number
              level: "high" | "medium" | "low"
              factors:
                - name: string
                  weight: number
                  reason: string
              tags: string[]
        metadata:
          totalFiles: number
          totalHunks: number
          analysisTime: number
    202:
      id: string
      status: "running"
      progress:
        phase: "cloning" | "gathering" | "analyzing"
        current: number
        total: number
    404:
      error: "Analysis not found"
```

---

## 7. Key Algorithms

### 7.1 Importance Scoring Algorithm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         IMPORTANCE SCORING                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: DiffHunk, Context
Output: ImportanceScore (0-100)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FACTORS                                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. CENTRALITY (0-30 points)                                                â”‚
â”‚     â””â”€ callers > 10   â†’ +25 "high_centrality"                               â”‚
â”‚     â””â”€ callers > 5    â†’ +15 "medium_centrality"                             â”‚
â”‚     â””â”€ callers > 0    â†’ +5  "some_callers"                                  â”‚
â”‚                                                                             â”‚
â”‚  2. SECURITY (0-30 points)                                                  â”‚
â”‚     â””â”€ file matches /auth|security|crypto|password|token|secret/            â”‚
â”‚        â†’ +30 "security_sensitive"                                           â”‚
â”‚     â””â”€ content contains password/token patterns                             â”‚
â”‚        â†’ +20 "sensitive_data"                                               â”‚
â”‚                                                                             â”‚
â”‚  3. API SURFACE (0-25 points)                                               â”‚
â”‚     â””â”€ changes exported function/class                                      â”‚
â”‚        â†’ +25 "public_api"                                                   â”‚
â”‚     â””â”€ changes function signature                                           â”‚
â”‚        â†’ +20 "breaking_change_risk"                                         â”‚
â”‚     â””â”€ adds/removes exports                                                 â”‚
â”‚        â†’ +15 "export_change"                                                â”‚
â”‚                                                                             â”‚
â”‚  4. TEST COVERAGE (0-15 points)                                             â”‚
â”‚     â””â”€ no related tests found                                               â”‚
â”‚        â†’ +15 "untested"                                                     â”‚
â”‚     â””â”€ tests exist but not updated                                          â”‚
â”‚        â†’ +10 "tests_not_updated"                                            â”‚
â”‚                                                                             â”‚
â”‚  5. CODE SMELL (0-15 points)                                                â”‚
â”‚     â””â”€ contains TODO/FIXME/HACK                                             â”‚
â”‚        â†’ +10 "incomplete"                                                   â”‚
â”‚     â””â”€ large function (>50 lines changed)                                   â”‚
â”‚        â†’ +10 "large_change"                                                 â”‚
â”‚     â””â”€ complex control flow added                                           â”‚
â”‚        â†’ +5  "complexity"                                                   â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SCORE CALCULATION                                                          â”‚
â”‚                                                                             â”‚
â”‚  score = min(100, sum(factor.weight for factor in matched_factors))         â”‚
â”‚                                                                             â”‚
â”‚  level = score >= 60 ? "high"                                               â”‚
â”‚        : score >= 30 ? "medium"                                             â”‚
â”‚        : "low"                                                              â”‚
â”‚                                                                             â”‚
â”‚  tags = [factor.name for factor in matched_factors]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 LLM Prompt Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LLM PROMPT STRUCTURE                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SYSTEM PROMPT                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  You are Flint, a code review assistant. Analyze code changes and           â”‚
â”‚  explain their semantics for code reviewers.                                â”‚
â”‚                                                                             â”‚
â”‚  Repository Guidelines:                                                     â”‚
â”‚  {guidelines from AGENTS.md / CONTRIBUTING.md}                              â”‚
â”‚                                                                             â”‚
â”‚  Your analysis must include:                                                â”‚
â”‚  1. Summary: 1-2 sentences explaining the change                            â”‚
â”‚  2. Intent: What the developer was trying to achieve                        â”‚
â”‚  3. Behavior Change: What's different after this change                     â”‚
â”‚  4. Implications: Potential side effects (array)                            â”‚
â”‚  5. Review Hints: What reviewers should check (array)                       â”‚
â”‚                                                                             â”‚
â”‚  Respond in JSON format. Be concise and technical.                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER PROMPT (per hunk)                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ## File: {filePath}                                                        â”‚
â”‚                                                                             â”‚
â”‚  ## Diff:                                                                   â”‚
â”‚  ```diff                                                                    â”‚
â”‚  {unified diff content}                                                     â”‚
â”‚  ```                                                                        â”‚
â”‚                                                                             â”‚
â”‚  ## Containing Function:                                                    â”‚
â”‚  ```{language}                                                              â”‚
â”‚  {full function/class containing the change}                                â”‚
â”‚  ```                                                                        â”‚
â”‚                                                                             â”‚
â”‚  ## Files that import this ({count}):                                       â”‚
â”‚  {list of caller files, max 10}                                             â”‚
â”‚                                                                             â”‚
â”‚  ## Related Tests:                                                          â”‚
â”‚  {list of test files}                                                       â”‚
â”‚                                                                             â”‚
â”‚  ## Importance Score: {score}/100 ({level})                                 â”‚
â”‚  Factors: {comma-separated tags}                                            â”‚
â”‚                                                                             â”‚
â”‚  Analyze this change.                                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Chrome Extension UI

### 8.1 GitHub PR Page with Flint Overlay

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            GITHUB PR PAGE (with Flint overlay)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  github.com/owner/repo/pull/123                                          [Flint â–¼]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  PR #123: Add user authentication                                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                         â”‚
â”‚  Files changed (3)  [Analyze with Flint ðŸ”¥]                                             â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  src/auth.ts  (+45, -12)                                                        â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  @@ -10,5 +10,15 @@ export function authenticate(user: User)                   â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  ðŸ”´ 75/100  [security] [public_api]                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Adds JWT token validation with expiry checking.                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â–¼ Details                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Intent: Add token expiration validation to prevent stale      â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  sessions from accessing protected resources.                   â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                                                 â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Behavior Change: Requests with expired tokens will now        â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  return 401 instead of being processed.                         â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                                                                 â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Review Checklist:                                              â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ Verify token expiry time is configurable                     â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ Check error message doesn't leak sensitive info              â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ Ensure refresh token flow is updated                         â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â–¼ Why 75/100?                                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ security_sensitive: +30 (auth-related file)                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ public_api: +25 (changes exported function)                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ high_centrality: +20 (8 files import this)                           â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚     10 â”‚   export function authenticate(user: User) {                          â”‚   â”‚
â”‚  â”‚     11 â”‚ +   const token = getToken(user);                                     â”‚   â”‚
â”‚  â”‚     12 â”‚ +   if (isExpired(token)) {                                           â”‚   â”‚
â”‚  â”‚     13 â”‚ +     throw new AuthError('Token expired');                           â”‚   â”‚
â”‚  â”‚     14 â”‚ +   }                                                                 â”‚   â”‚
â”‚  â”‚     15 â”‚     return validateCredentials(user);                                 â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  src/utils/token.ts  (+12, -0)                                                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  ðŸŸ¢ 25/100  [new_file]                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Adds utility function for checking token expiration.                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â–¼ Details                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Overlay Panel Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ”´ 75/100  [security] [public_api]                                     â”‚
â”‚                                                                         â”‚
â”‚  Adds JWT token validation with expiry checking.                        â”‚
â”‚                                                                         â”‚
â”‚  â–¼ Details                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Intent: Add token expiration validation to prevent stale      â”‚   â”‚
â”‚  â”‚  sessions from accessing protected resources.                   â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  Behavior Change: Requests with expired tokens will now        â”‚   â”‚
â”‚  â”‚  return 401 instead of being processed.                         â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  Review Checklist:                                              â”‚   â”‚
â”‚  â”‚  â€¢ Verify token expiry time is configurable                     â”‚   â”‚
â”‚  â”‚  â€¢ Check error message doesn't leak sensitive info              â”‚   â”‚
â”‚  â”‚  â€¢ Ensure refresh token flow is updated                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â–¼ Why 75/100?                                                          â”‚
â”‚  â€¢ security_sensitive: +30 (auth-related file)                          â”‚
â”‚  â€¢ public_api: +25 (changes exported function)                          â”‚
â”‚  â€¢ high_centrality: +20 (8 files import this)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 Color Coding

| Level | Color | Score Range |
|-------|-------|-------------|
| ðŸ”´ High | Red (#dc2626) | 60-100 |
| ðŸŸ¡ Medium | Yellow (#f59e0b) | 30-59 |
| ðŸŸ¢ Low | Green (#22c55e) | 0-29 |

---

## 9. Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DEPLOYMENT ARCHITECTURE                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   Cloudflare    â”‚
                                    â”‚   (DNS + CDN)   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    VERCEL                                               â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Next.js Application                                                            â”‚   â”‚
â”‚  â”‚  flint.app                                                                      â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚  API Route  â”‚  â”‚  API Route  â”‚  â”‚  API Route  â”‚  â”‚  Landing    â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  /analyze   â”‚  â”‚  /auth      â”‚  â”‚  /repos     â”‚  â”‚  Page       â”‚           â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚           â”‚   â”‚
â”‚  â”‚  â”‚  Edge Fn    â”‚  â”‚  Edge Fn    â”‚  â”‚  Edge Fn    â”‚  â”‚  Static     â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                                              â”‚
â”‚                         â–¼                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Vercel Sandbox Pool                                                            â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚ Sandbox â”‚  â”‚ Sandbox â”‚  â”‚ Sandbox â”‚  â”‚ Sandbox â”‚  ...                       â”‚   â”‚
â”‚  â”‚  â”‚  (VM1)  â”‚  â”‚  (VM2)  â”‚  â”‚  (VM3)  â”‚  â”‚  (VM4)  â”‚                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Vercel KV (Redis)                     â”‚  Vercel Postgres                       â”‚   â”‚
â”‚  â”‚  â€¢ Session cache                       â”‚  â€¢ Users                               â”‚   â”‚
â”‚  â”‚  â€¢ Rate limiting                       â”‚  â€¢ Analyses                            â”‚   â”‚
â”‚  â”‚  â€¢ Analysis queue                      â”‚  â€¢ Repositories                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  External Services          â”‚
                              â”‚                             â”‚
                              â”‚  â€¢ GitHub API               â”‚
                              â”‚  â€¢ Anthropic Claude API     â”‚
                              â”‚  â€¢ Chrome Web Store         â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Implementation Plan

### Week 1: Backend + Sandbox Integration

| Day | Task | Details |
|-----|------|---------|
| 1 | Project setup | Next.js app, Vercel project, @vercel/sandbox |
| 2 | GitHub OAuth | NextAuth.js, token storage |
| 3 | Sandbox clone | Clone repo, checkout PR branch |
| 4 | Diff parser | Parse git diff into structured hunks |
| 5 | Context gatherer | ripgrep commands, file reading |
| 6 | File parsing | Extract functions, imports, exports |
| 7 | Integration test | End-to-end: PR URL â†’ context |

**Deliverables:**
- [ ] Next.js app deployed to Vercel
- [ ] GitHub OAuth working
- [ ] Sandbox clones repo and gathers context
- [ ] Diff parsed into structured format

### Week 2: Analysis Pipeline + LLM

| Day | Task | Details |
|-----|------|---------|
| 1 | Importance scorer | Implement scoring algorithm |
| 2 | LLM prompt design | System + user prompts |
| 3 | Claude integration | API calls, structured output |
| 4 | Batch processing | Analyze multiple hunks efficiently |
| 5 | Caching layer | PostgreSQL + Redis caching |
| 6 | API endpoints | /api/analyze complete |
| 7 | Error handling | Timeouts, retries |

**Deliverables:**
- [ ] Importance scoring working
- [ ] Claude API integration
- [ ] Results cached in database
- [ ] API returns analysis results

### Week 3: Chrome Extension

| Day | Task | Details |
|-----|------|---------|
| 1 | Extension scaffold | Manifest V3, Plasmo/WXT |
| 2 | GitHub detection | Detect PR pages, extract info |
| 3 | Diff hunk detection | Find hunks in DOM |
| 4 | UI injection | Inject overlay containers |
| 5 | Panel components | SemanticPanel, ImportanceBadge |
| 6 | Auth flow | GitHub OAuth in extension |
| 7 | Polish + testing | Error states, loading |

**Deliverables:**
- [ ] Extension installed and working
- [ ] Overlays injected on GitHub PR pages
- [ ] Full flow working end-to-end

---

## 11. Tech Stack

| Component | Technology | Why |
|-----------|------------|-----|
| **Backend** | Next.js 14+ (App Router) | API routes, edge functions, Vercel integration |
| **Sandbox** | @vercel/sandbox | Clone repos, run commands, managed VMs |
| **Database** | PostgreSQL (Neon) | Relational data, JSONB for results |
| **Cache** | Vercel KV (Redis) | Sessions, rate limiting |
| **Auth** | NextAuth.js | GitHub OAuth |
| **LLM** | Anthropic Claude | Best code understanding |
| **Extension** | Plasmo or WXT | Modern extension framework |
| **Styling** | Tailwind CSS | Fast styling |
| **Hosting** | Vercel | Seamless deployment |

### Cost Estimation

| Item | Estimate |
|------|----------|
| Vercel Sandbox | Free tier, then usage-based |
| Claude API | ~$0.01-0.05 per PR |
| Vercel Hosting | Free â†’ $20/mo Pro |
| Database (Neon) | Free tier |

---

## Appendix: Key Code Snippets

### A.1 Sandbox Creation

```typescript
import { Sandbox } from '@vercel/sandbox'
import ms from 'ms'

async function createRepoSandbox(input: {
  owner: string
  repo: string
  branch: string
  token: string
}) {
  return Sandbox.create({
    source: {
      type: 'git',
      url: `https://github.com/${input.owner}/${input.repo}.git`,
      username: 'x-access-token',
      password: input.token,
      depth: 1,
      revision: input.branch,
    },
    runtime: 'node24',
    timeout: ms('5m'),
  })
}
```

### A.2 Context Gathering

```typescript
async function gatherContext(sandbox: Sandbox, file: string) {
  const [callers, tests, content] = await Promise.all([
    sandbox.runCommand('rg', ['--json', `import.*from.*${file}`, '.']),
    sandbox.runCommand('find', ['.', '-name', `${basename(file)}.test.*`]),
    sandbox.readFileToBuffer({ path: file }),
  ])
  
  return {
    callers: parseRipgrepJson(await callers.stdout()),
    tests: (await tests.stdout()).split('\n').filter(Boolean),
    content: content?.toString() ?? '',
  }
}
```

### A.3 Importance Scoring

```typescript
function scoreImportance(hunk: DiffHunk, context: Context): ImportanceScore {
  const factors = []
  
  if (context.callers.length > 10) {
    factors.push({ name: 'high_centrality', weight: 25, reason: `${context.callers.length} files depend on this` })
  }
  
  if (/auth|security|crypto/i.test(hunk.file)) {
    factors.push({ name: 'security', weight: 30, reason: 'Security-sensitive file' })
  }
  
  if (context.tests.length === 0) {
    factors.push({ name: 'untested', weight: 15, reason: 'No tests found' })
  }
  
  const score = Math.min(100, factors.reduce((sum, f) => sum + f.weight, 0))
  const level = score >= 60 ? 'high' : score >= 30 ? 'medium' : 'low'
  
  return { score, level, factors, tags: factors.map(f => f.name) }
}
```

### A.4 Semantic Analysis

```typescript
import Anthropic from '@anthropic-ai/sdk'

const client = new Anthropic()

async function analyzeSemantics(
  hunk: DiffHunk,
  context: ContextResult,
  importance: ImportanceScore,
  guidelines: string
): Promise<SemanticAnalysis> {
  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 1024,
    system: `You are Flint, a code review assistant...`,
    messages: [{
      role: 'user',
      content: `Analyze this code change:

## File: ${hunk.file}

## Diff:
\`\`\`diff
${hunk.diff}
\`\`\`

## Containing function:
\`\`\`
${context.containingFunction}
\`\`\`

## Files that import this (${context.callers.length}):
${context.callers.slice(0, 10).join('\n')}

## Importance: ${importance.score}/100 (${importance.level})
Tags: ${importance.tags.join(', ')}

Provide your analysis as JSON.`,
    }],
  })
  
  return JSON.parse(response.content[0].text)
}
```

### A.5 GitHub Page Detection (Extension)

```typescript
export function detectPRPage(): PRInfo | null {
  const match = window.location.pathname.match(
    /^\/([^/]+)\/([^/]+)\/pull\/(\d+)/
  )
  if (!match) return null
  
  return {
    owner: match[1],
    repo: match[2],
    prNumber: parseInt(match[3]),
    branch: extractBranchFromPage(),
  }
}

export function findDiffHunks(): DiffHunkElement[] {
  const hunks: DiffHunkElement[] = []
  const fileContainers = document.querySelectorAll('.file[data-file-type]')
  
  for (const container of fileContainers) {
    const filePath = container.getAttribute('data-path') ?? ''
    const hunkHeaders = container.querySelectorAll('.blob-code-hunk')
    
    for (const header of hunkHeaders) {
      hunks.push({
        element: header.closest('tr')!,
        file: filePath,
        header: header.textContent ?? '',
        lines: collectHunkLines(header),
      })
    }
  }
  
  return hunks
}
```

### A.6 Semantic Panel Component (Extension)

```tsx
interface SemanticPanelProps {
  analysis: {
    semantic: SemanticAnalysis
    importance: ImportanceScore
  }
  onClose: () => void
}

export function SemanticPanel({ analysis, onClose }: SemanticPanelProps) {
  const { semantic, importance } = analysis
  
  const levelColors = {
    high: '#dc2626',
    medium: '#f59e0b',
    low: '#22c55e',
  }
  
  return (
    <div className="pr-semantic-panel">
      <div className="panel-header">
        <ImportanceBadge 
          score={importance.score} 
          level={importance.level} 
        />
        <button onClick={onClose} className="close-btn">Ã—</button>
      </div>
      
      <div className="tags">
        {importance.tags.map(tag => (
          <span key={tag} className="tag">{tag}</span>
        ))}
      </div>
      
      <div className="summary">
        {semantic.summary}
      </div>
      
      <details className="details-section">
        <summary>Intent & Behavior</summary>
        <p><strong>Intent:</strong> {semantic.intent}</p>
        <p><strong>Changed:</strong> {semantic.behaviorChange}</p>
      </details>
      
      <details className="details-section">
        <summary>Review Checklist</summary>
        <ul>
          {semantic.reviewHints.map((hint, i) => (
            <li key={i}>{hint}</li>
          ))}
        </ul>
      </details>
      
      <details className="details-section">
        <summary>Why {importance.score}/100?</summary>
        <ul>
          {importance.factors.map((f, i) => (
            <li key={i}>
              <strong>{f.name}</strong>: {f.reason} (+{f.weight})
            </li>
          ))}
        </ul>
      </details>
    </div>
  )
}
```

---

## Appendix: TypeScript Types

```typescript
// Core types for Flint

interface PRInfo {
  owner: string
  repo: string
  prNumber: number
  branch: string
}

interface DiffHunk {
  file: string
  startLine: number
  endLine: number
  oldCode: string
  newCode: string
  header: string
}

interface ContextResult {
  callers: string[]
  tests: string[]
  imports: string[]
  containingFunction: string
  guidelines: string
}

interface ImportanceScore {
  score: number
  level: 'high' | 'medium' | 'low'
  factors: ImportanceFactor[]
  tags: string[]
}

interface ImportanceFactor {
  name: string
  weight: number
  reason: string
}

interface SemanticAnalysis {
  summary: string
  intent: string
  behaviorChange: string
  implications: string[]
  reviewHints: string[]
}

interface HunkAnalysis {
  hunk: DiffHunk
  context: ContextResult
  importance: ImportanceScore
  semantic: SemanticAnalysis
}

interface PRAnalysis {
  id: string
  owner: string
  repo: string
  prNumber: number
  commitSha: string
  status: 'pending' | 'running' | 'completed' | 'failed'
  hunks: HunkAnalysis[]
  metadata: {
    totalFiles: number
    totalHunks: number
    analysisTime: number
  }
}
```

---

*Last updated: January 2026*
